---
title: "opportunity_insights"
author: "Amy Tan"
date: "2/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(haven)
library(dplyr)
library(tibble)
library(stringr)
library(fs)
library(devtools)
library(ggthemr)
library(cowplot)
library(tidyverse)



```

```{r}

# all_outcomes <- read.csv("raw-data/county_outcomes.csv")

# all_outcomes %>% glimpse()

# all_outcome data is too big so using different dataset instead for only
# household income and incarceration rates

download.file("https://opportunityinsights.org/wp-content/uploads/2018/10/county_outcomes_simple.csv", "raw-data/county_outcomes_simple.csv", mode="wb")

oi_county_outcomes <- read.csv("raw-data/county_outcomes_simple.csv")

# the county variable was a factor variable instead of a numeric variable, so I made # it numeric to match the county variable in the other dataset

oi_county_outcomes$county_num <- as.numeric(oi_county_outcomes %>% pull(county))

# also made the state variables numeric because I will need to merge the state and county IDs to match the five-digit FIPS county code in the stanford dataset

oi_county_outcomes$state_num <- as.numeric(oi_county_outcomes %>% pull(state))

# since the 5-digit FIPS code is formatted such that if there was a county code that # was less than 3 digits, there would be a 0 in front of it, I added 0s to county_num

oi_county_outcomes <- oi_county_outcomes %>% 
  mutate(county_pad=str_pad(county_num, 3, pad="0","left"))

# I used paste0 to merge the county and state together into one countyid to match the countyid in the other dataset

oi_county_outcomes$countyid <- paste0(oi_county_outcomes$state_num, oi_county_outcomes$county_pad)

# I also made sure that the merged column was numeric to merge with other datasets later

oi_county_outcomes$countyid <- as.numeric(oi_county_outcomes %>% pull(countyid))

```


```{r}
download.file("https://stacks.stanford.edu/file/druid:db586ns4974/seda_county_poolsub_cs_v30.csv", "raw-data/seda_county_poolsub_cs.csv", mode="wb")

# does not have grade or year (use original long dataset instead if necessary),
# but has scores, average learning rate, and trend in average test scores

county_poolsub <- read.csv("raw-data/seda_county_poolsub_cs.csv")

```

```{r }
# covariate data on SES variables 

download.file("https://stacks.stanford.edu/file/druid:db586ns4974/SEDA_cov_county_pool_v30.csv", "raw-data/seda_cov_county_pool.csv", mode="wb")

seda_cov <- read.csv("raw-data/seda_cov_county_pool.csv")

# more detailed data on racial achievement gaps

download.file("https://stacks.stanford.edu/file/druid:db586ns4974/seda_county_long_cs_v30.csv", "raw-data/seda_county_long.csv", mode="wb")

seda_long <- read.csv("raw-data/seda_county_long.csv")


```

```{r}
# merging data together
# example code
left_join(x, y, by='Flag') %>%
                left_join(., z, by='Flag')

# smaller dataset by only covariates, not the full long test score data from SEDA
seda_oi_cov <- full_join(county_poolsub, seda_cov, by="countyid") %>% 
  full_join(., oi_county_outcomes, by = "countyid")

# all SEDA data in one dataset
seda_cov_joined <-full_join(county_poolsub, seda_cov, by="countyid") %>% 
  full_join(., seda_long, by = "countyid")

# SEDA long test score data and covariates datasets only
seda_scores_cov <- full_join(seda_long, seda_cov, by = "countyid")
  
# full dataset
seda_oi <- full_join(county_poolsub, seda_cov, by="countyid") %>% 
  full_join(., seda_long, by = "countyid") %>% 
  full_join(., oi_county_outcomes, by = "countyid")

# full dataset = seda_oi

#seda_oi <- full_join(seda_full, oi_county_outcomes, by="countyid")
```

```{r}

# regressions on intergenerational mobility and avg test scores

# right now, test scores are still significant with all these controls 

kfr_avg_math = lm(kfr_pooled_pooled_p25 ~ mn_avg_mth_ol + rswhtblk + rsecdnec, data = seda_oi)

# when you add the composite SES score, the significance of test scores go away

kfr_avg_math_1 = lm(kfr_pooled_pooled_p25 ~ mn_avg_mth_ol + sesavgall + rsecdnec + rswhtblk, data = seda_oi)

summary(kfr_avg_math)
summary(kfr_avg_math_1)

# do the exact same thing with ELA

kfr_avg_ela = lm(kfr_pooled_pooled_p25 ~ mn_avg_ela_ol + rswhtblk + rsecdnec, data = seda_oi)

kfr_avg_ela_1 = lm(kfr_pooled_pooled_p25 ~ mn_avg_ela_ol + sesavgall + rsecdnec + rswhtblk, data = seda_oi)

summary(kfr_avg_ela)

# interesting result because for ELA (and NOT math), test scores are still
# significant for intergenerational mobility regardless of SES + race

summary(kfr_avg_ela_1)

```

```{r}

# maybe customize if have time: 
# ggthemr("fresh") 
# ggthemr_reset()

# plot of intergenerational mobility and avg test scores

mob_avg_ela_plot <- seda_oi %>% 
  ggplot(aes(x=mn_avg_ela_ol, y= kfr_pooled_pooled_p25)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Intergenerational Mobility and ELA Test Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized ELA Score",
       y = "Household Income Percentile for Children From 25th Percentile") +
  theme_bw()

```
```{r}
# plots of intergenerational mobility rates with different percentage of economically disadvantaged students

# subsetting the data
perecd_25 <- seda_oi %>% 
  filter(perecd <= .25) %>% 
  ggplot(aes(x=mn_all, y= kfr_pooled_pooled_p25)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Intergenerational Mobility and ELA Test Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized ELA Score",
       y = "Household Income Percentile for Children From 25th Percentile") +
  theme_bw()


perecd_50 <- seda_oi_cov %>% 
  filter(perecd <=.50 & perecd >.25) %>% 
  ggplot(aes(x=mn_avg_mth_eb, y= kfr_pooled_pooled_p25)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Intergenerational Mobility and ELA Test Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized ELA Score",
       y = "Household Income Percentile for Children From 25th Percentile") +
  theme_bw()  



```

```{r}
# plots of school segregation on test scores by racial group (use seda_oi)

# Variables:
# rswhtblk
# rswhthsp
# rsecdnec
# 
# mn_wht
# mn_asn
# mn_blk
# mn_hsp
# mn_ecd
# mn_nec

rswhtblk_blk <- seda_scores_cov %>% 
  ggplot(aes(x=mn_blk, y= rswhtblk)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Black-White Segregation and Black Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw()  

rswhtblk_wht <- seda_scores_cov %>% 
  ggplot(aes(x=mn_wht, y= rswhtblk)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Black-White Segregation and White Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw() 

rswhtblk_comb_plot <- plot_grid(rswhtblk_blk, rswhtblk_wht)

# rswhtblk_blk_1 <- seda_scores_cov %>%
#   ggplot(aes(x=mn_blk, y= rswhtblk)) +
#   geom_point(alpha=.5) +
#   geom_smooth(method=lm, se= FALSE)
#
# rswhtblk_wht_1 <- seda_scores_cov %>%
#   ggplot(aes(x=mn_wht, y= rswhtblk)) +
#   geom_point(alpha=.5) +
#   geom_smooth(method=lm, se= FALSE)

# # --- test---
# plot_row <- plot_grid(rswhtblk_blk_1, rswhtblk_wht_1)
# 
# # now add the title
# title <- ggdraw() + 
#   draw_label(
#     "Black-White Segregation and Test Scores by Race",
#     fontface = 'bold',
#     x = 0,
#     hjust = 0
#   ) +
#   theme(
#     # add margin on the left of the drawing canvas,
#     # so title is aligned with left edge of first plot
#     plot.margin = margin(0, 0, 0, 7)
#   )
# x <-plot_grid(
#   title, plot_row,
#   ncol = 1,
#   # rel_heights values control vertical title margins
#   rel_heights = c(0.1, 1),
#   labels = c("Black Students", "White Students")
# )
# 
# 
# 
# title_theme <- ggdraw() +
#   draw_label("Socio-economic measures", 
#              fontfamily = theme_georgia()$text$family, 
#              fontface = theme_georgia()$plot.title$face, x = 0.05, hjust = 0)
# plot_grid(title_theme, gridded, ncol = 1, rel_heights = c(0.2, 1))


rswhthsp_hsp <- seda_scores_cov %>% 
  ggplot(aes(x=mn_hsp, y= rswhthsp)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Hispanic-White Segregation and Hispanic Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw() 


rswhthsp_wht <- seda_scores_cov %>% 
  ggplot(aes(x=mn_wht, y= rswhthsp)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Hispanic-White Segregation and White Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw()  

rswhthsp_wht <- seda_scores_cov %>% 
  ggplot(aes(x=mn_wht, y= rswhthsp)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "Hispanic-White Segregation and White Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw()  

rsecdnec_ecd <- seda_scores_cov %>% 
  ggplot(aes(x=mn_ecd, y= rsecdnec)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "ECD/Non-ECD Segregation and ECD Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw()  

rsecdnec_nec <- seda_scores_cov %>% 
  ggplot(aes(x=mn_nec, y= rsecdnec)) +
  geom_point(alpha=.5) + 
  geom_smooth(method=lm, se= FALSE) +
  labs(title = "ECD/Non-ECD Segregation and Non-ECD Students' Scores",
       subtitle = "National Data on 3rd-8th graders, 2008-2016",
       caption = "Data from Opportunity Insights and Stanford Education Data Archive.",
       x = "Mean Standardized Score",
       y = "Relative Diversity Index") +
  theme_bw()  

rsecdnec_comb_plot <- plot_grid(rsecdnec_ecd, rsecdnec_nec)

# maybe add in subsetting by income later?

```

```{r}
# regressions for intergenerational mobility and average learning rate

kfr_grd_math = lm(kfr_pooled_pooled_p25 ~ mn_grd_mth_ol + rswhtblk + rsecdnec, data = seda_oi)
kfr_grd_math_1 = lm(kfr_pooled_pooled_p25 ~ mn_grd_mth_ol + rswhtblk + rsecdnec + sesavgall, data = seda_oi)

# no matter which controls you add in, average learning rate (how much a grade
# learns over time) is still significant for intergenerational mobility

summary(kfr_grd_math)
summary(kfr_grd_math_1)

kfr_grd_ela = lm(kfr_pooled_pooled_p25 ~ mn_grd_ela_ol + rswhtblk + rsecdnec, data = seda_oi)
kfr_grd_ela_1 = lm(kfr_pooled_pooled_p25 ~ mn_grd_ela_ol + rswhtblk + rsecdnec + sesavgall, data = seda_oi)

# same results of significance for ELA

summary(kfr_grd_ela)
summary(kfr_grd_ela_1)

```

```{r}
kfr_coh_math = lm(kfr_pooled_pooled_p25 ~ mn_coh_mth_ol + rswhtblk + rsecdnec, data = seda_oi)
kfr_coh_math_1 = lm(kfr_pooled_pooled_p25 ~ mn_coh_mth_ol + rswhtblk + rsecdnec + sesavgall, data = seda_oi)

# improvement of scores for a school over time matters for intergen mobility

summary(kfr_coh_math)
summary(kfr_coh_math_1)

kfr_coh_ela = lm(kfr_pooled_pooled_p25 ~ mn_coh_ela_ol + rswhtblk + rsecdnec, data = seda_oi)
kfr_coh_ela_1 = lm(kfr_pooled_pooled_p25 ~ mn_coh_ela_ol + rswhtblk + rsecdnec + sesavgall, data = seda_oi)

# same results for ELA

summary(kfr_coh_ela)
summary(kfr_coh_ela_1)


```

```{r}
# regressions on the correlations between diversity within school and scores

div_score <- lm(mn_avg_mth_ol~ rswhtblk + rsecdnec + sesavgall, data = seda_oi)

# interesting that exposure to other ECD is not as important for math as it is
# for ELA
summary(div_score)

div_score_ela <-lm(mn_avg_ela_ol~ rswhtblk + rsecdnec + sesavgall, data = seda_oi)
summary(div_score_ela) 

```

